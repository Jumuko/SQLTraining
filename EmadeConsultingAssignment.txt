/**********************************************************************************************************************
DEVELOPER: JOHN O. UMUKORO
DATE CREATED: 2024-10-9
CODE VERSION: 1.0
DESCRIPTION: THIS CODE CREATES AND INSERTS RECORDS INTO EMADE CONSULTING TABLES, PROVIDES INFORMATION ABOUT LOCATIONS,DEPARTMENT,
			 JOB, EMPLOYEE, CUSTOMERS, PRODUCTS, AND ORDERS

**********************************************************************************************************************/


CREATE TABLE EMADECONSULTINGLOCATION
(
LOCATION_ID INT NOT NULL,
CITY VARCHAR (20) NULL,
)

INSERT INTO EMADECONSULTINGLOCATION
VALUES
(122, 'NEW YORK'),
(123, 'DALLAS'), 
(124, 'CHICAGO'), 
(167, 'BOSTON')


CREATE TABLE EMADECONSULTINGDEPARTMENT
(
DEPARTMENT_ID INT NOT NULL,
NAME VARCHAR(20) NULL,
LOCATION_ID INT NOT NULL
)

INSERT INTO EMADECONSULTINGDEPARTMENT
VALUES
(10, 'ACCOUNTING', 122),
(20, 'SALES', 124),
(30, 'RESEARCH', 123),
(40, 'OPERATIONS', 167)


CREATE TABLE EMADECONSULTINGJOB
(
JOB_ID INT NOT NULL, 
DESIGNATION VARCHAR (20) NULL
)

INSERT INTO EMADECONSULTINGJOB 
VALUES
(667, 'CLERK'),
(668, 'STAFF'),
(669, 'ANALYST'),
(670, 'SALES PERSON'),
(671, 'MANAGER'),
(672, 'PRESIDENT')


CREATE TABLE EMADECONSULTINGEMPLOYEE
(
EMPLOYEE_ID INT NOT NULL,
LAST_NAME VARCHAR(20) NULL,
FIRST_NAME VARCHAR(20) NULL,
MIDDLE_NAME VARCHAR(20) NULL,
JOB_ID INT NOT NULL,
MANAGER_ID INT NOT NULL, 
HIRE_DATE DATE NULL,
SALARY MONEY NULL,
COMM INT NULL,
DEPARTMENT_ID INT NOT NULL
)

INSERT INTO EMADECONSULTINGEMPLOYEE
VALUES
(7369, 'SMITH', 'JOHN', 'Q', 667, 7902, '17-DEC-84', 800, NULL, 20),
(7499, 'ALLEN', 'KEVIN', 'J', 670, 7698, '20-FEB-85', 1600, 300, 30),
(7505, 'DOYLE', 'JEAN', 'K', 671, 7839, '04-APR-85', 2850, NULL, 30),
(7506, 'DENNIS', 'LYNN', 'S', 671, 7839, '15-MAY-85', 2750, NULL, 30),
(7507, 'BAKER', 'LESLIE', 'D', 671, 7839, '10-JUN-85', 2200, NULL, 40),
(7521, 'WARK', 'CYNTHIA', 'D', 670, 7698, '22-FEB-85', 1250, 500, 30)


--CHECK NEWLY CREATED TABLES
SELECT *
FROM EMADECONSULTINGLOCATION

SELECT *
FROM EMADECONSULTINGDEPARTMENT

SELECT *
FROM EMADECONSULTINGJOB

SELECT *
FROM EMADECONSULTINGEMPLOYEE

--QUESTION 1- DISPLAY THE EMPLOYEE DETAILS WITH SALARY GRADES 

SELECT 
	A.FIRST_NAME,
	A.MIDDLE_NAME,
	A.LAST_NAME,
	A.HIRE_DATE,
	A.SALARY,
	B.DESIGNATION,
CASE
	WHEN SALARY < 1000 THEN 'INTERN'
	WHEN SALARY < 2000 THEN 'JUNIOR STAFF'
	ELSE 'SENIOR STAFF'
	END AS 'SALARY GRADE'
FROM EMADECONSULTINGEMPLOYEE A,
	 EMADECONSULTINGJOB B
WHERE A.JOB_ID=B.JOB_ID

--OR

SELECT 
	A.FIRST_NAME,
	A.MIDDLE_NAME,
	A.LAST_NAME,
	A.HIRE_DATE,
	A.SALARY,
	B.DESIGNATION,
	DENSE_RANK() OVER (ORDER BY SALARY DESC) SALARY_GRADE
FROM EMADECONSULTINGEMPLOYEE A,
	 EMADECONSULTINGJOB B
WHERE A.JOB_ID=B.JOB_ID


--QUESTION 2 - LIST OUT ALL THE JOBS IN SALES AND ACCOUNTING DEPARTMENTS

SELECT 
	A.JOB_ID,
	A.DESIGNATION,
	C.NAME DEPARTMENT
FROM EMADECONSULTINGJOB A
	FULL JOIN EMADECONSULTINGEMPLOYEE B 
	ON A.JOB_ID=B.JOB_ID
	FULL JOIN EMADECONSULTINGDEPARTMENT C 
	ON B.DEPARTMENT_ID=C.DEPARTMENT_ID
WHERE C.NAME='SALES'
OR C.NAME= 'ACCOUNTING'


SELECT 
	A.JOB_ID,
	A.DESIGNATION,
	C.NAME DEPARTMENT
FROM EMADECONSULTINGJOB A
	FULL JOIN EMADECONSULTINGEMPLOYEE B 
	ON A.JOB_ID=B.JOB_ID
	FULL JOIN EMADECONSULTINGDEPARTMENT C 
	ON B.DEPARTMENT_ID=C.DEPARTMENT_ID
WHERE C.DEPARTMENT_ID IN (10,20)


--QUESTION 3 - DISPLAY THE EMPLOYEES LIST WITH HIGHEST SALARY 
SELECT TOP 1
	A.FIRST_NAME,
	A.MIDDLE_NAME,
	A.LAST_NAME,
	A.HIRE_DATE,
	A.SALARY,
	B.DESIGNATION,
	C.NAME DEPT,
	D.CITY
FROM EMADECONSULTINGEMPLOYEE A,
	 EMADECONSULTINGJOB B,
	 EMADECONSULTINGDEPARTMENT C,
	 EMADECONSULTINGLOCATION D
WHERE A.JOB_ID=B.JOB_ID
AND   A.DEPARTMENT_ID=C.DEPARTMENT_ID
AND   C.LOCATION_ID=D.LOCATION_ID
ORDER BY A.SALARY DESC

--OR

SELECT 
	A.FIRST_NAME,
	A.MIDDLE_NAME,
	A.LAST_NAME,
	A.HIRE_DATE,
	A.SALARY,
	B.DESIGNATION,
	C.NAME DEPT,
	D.CITY
FROM EMADECONSULTINGEMPLOYEE A
	 FULL JOIN EMADECONSULTINGJOB B 
	 ON A.JOB_ID=B.JOB_ID
	 FULL JOIN EMADECONSULTINGDEPARTMENT C 
	 ON A.DEPARTMENT_ID=C.DEPARTMENT_ID
	 FULL JOIN EMADECONSULTINGLOCATION D
	 ON C.LOCATION_ID=D.LOCATION_ID
WHERE A.SALARY =
	(
	SELECT 
		MAX(SALARY) HIGHEST_SALARY
	FROM EMADECONSULTINGEMPLOYEE A
		 FULL JOIN EMADECONSULTINGJOB B 
		 ON A.JOB_ID=B.JOB_ID
		 FULL JOIN EMADECONSULTINGDEPARTMENT C 
		 ON A.DEPARTMENT_ID=C.DEPARTMENT_ID
		 FULL JOIN EMADECONSULTINGLOCATION D
		 ON C.LOCATION_ID=D.LOCATION_ID
	)

--QUESTION 4 - DISPLAY EMPLOYEES WHO ARE WORKING IN SALES DEPARTMENT
SELECT 
	A.FIRST_NAME,
	A.MIDDLE_NAME,
	A.LAST_NAME,
	A.HIRE_DATE,
	A.SALARY,
	B.DESIGNATION,
	C.NAME DEPT,
	D.CITY
FROM EMADECONSULTINGEMPLOYEE A
	 FULL JOIN EMADECONSULTINGJOB B 
	 ON A.JOB_ID=B.JOB_ID
	 FULL JOIN EMADECONSULTINGDEPARTMENT C 
	 ON A.DEPARTMENT_ID=C.DEPARTMENT_ID
	 FULL JOIN EMADECONSULTINGLOCATION D
	 ON C.LOCATION_ID=D.LOCATION_ID
WHERE C.NAME='SALES'

--QUESTION 5 - FIND OUT THE NO. OF EMPLOYEES WORKING IN SALES DEPARTMENT 
SELECT 
	C.NAME DEPARTMENT,
	COUNT(C.NAME) 'NO. OF EMPLOYEES'
FROM EMADECONSULTINGEMPLOYEE A
	 FULL JOIN EMADECONSULTINGJOB B 
	 ON A.JOB_ID=B.JOB_ID
	 FULL JOIN EMADECONSULTINGDEPARTMENT C 
	 ON A.DEPARTMENT_ID=C.DEPARTMENT_ID
	 FULL JOIN EMADECONSULTINGLOCATION D
	 ON C.LOCATION_ID=D.LOCATION_ID
WHERE C.NAME='SALES'
GROUP BY C.NAME;

--QUESTION 6 - DISPLAY THE SECOND HIGHEST SALARY DRAWING EMPLOYEE DETAILS
WITH GRADE AS
	(
	SELECT 
		A.FIRST_NAME,
		A.MIDDLE_NAME,
		A.LAST_NAME,
		A.HIRE_DATE,
		A.SALARY,
		B.DESIGNATION,
		DENSE_RANK() OVER (ORDER BY SALARY DESC) SALARY_GRADE
	FROM EMADECONSULTINGEMPLOYEE A,
		 EMADECONSULTINGJOB B
	WHERE A.JOB_ID=B.JOB_ID
	) 
SELECT 
	FIRST_NAME,
	MIDDLE_NAME,
	LAST_NAME,
	HIRE_DATE,
	SALARY,
	DESIGNATION
FROM GRADE
WHERE SALARY_GRADE=2

--QUESTION 7 - LIST OUT EMPLOYEES WHO EARN LESS THAN EVERY EMPLOYEE IN DEPARTMENT 30

SELECT 
	A.FIRST_NAME,
	A.MIDDLE_NAME,
	A.LAST_NAME,
	A.HIRE_DATE,
	A.SALARY,
	B.DESIGNATION,
	C.NAME DEPT,
	D.CITY
FROM EMADECONSULTINGEMPLOYEE A
	FULL JOIN EMADECONSULTINGJOB B 
	ON A.JOB_ID=B.JOB_ID
	FULL JOIN EMADECONSULTINGDEPARTMENT C 
	ON A.DEPARTMENT_ID=C.DEPARTMENT_ID
	FULL JOIN EMADECONSULTINGLOCATION D
	ON C.LOCATION_ID=D.LOCATION_ID
WHERE A.SALARY >
	(
	SELECT 
		MAX(SALARY) HIGHEST_SALARY
	FROM 
		(
		SELECT 
			A.FIRST_NAME,
			A.MIDDLE_NAME,
			A.LAST_NAME,
			A.HIRE_DATE,
			A.SALARY,
			A.Department_ID,
			B.DESIGNATION,
			C.NAME DEPT,
			D.CITY
		FROM EMADECONSULTINGEMPLOYEE A
			 FULL JOIN EMADECONSULTINGJOB B 
			 ON A.JOB_ID=B.JOB_ID
			 FULL JOIN EMADECONSULTINGDEPARTMENT C 
			 ON A.DEPARTMENT_ID=C.DEPARTMENT_ID
			 FULL JOIN EMADECONSULTINGLOCATION D
			 ON C.LOCATION_ID=D.LOCATION_ID
		WHERE C.DEPARTMENT_ID='30'
		) X
	);
--QUESTION 7 - LIST OUT EMPLOYEES WHO EARN LESS THAN EVERY EMPLOYEE IN DEPARTMENT 30
	SELECT * 
	FROM EmadeconsultingEMPLOYEE
	WHERE SALARY <
	(SELECT MIN(SALARY)
	FROM EmadeconsultingEMPLOYEE
	WHERE Department_ID=30
	)

--QUESTION 8 - FIND OUT THE EMPLOYEES WHO EARN GREATER THAN THE AVERAGE SALARY FOR THEIR DEPARTMENT(USED CHATGPT, REQUIRE EXPLANATION)

SELECT 
    A.FIRST_NAME,
    A.MIDDLE_NAME,
    A.LAST_NAME,
    A.HIRE_DATE,
    A.SALARY,
    B.DESIGNATION,
    C.NAME AS DEPT,
    D.CITY
FROM 
    EMADECONSULTINGEMPLOYEE A
FULL JOIN 
    EMADECONSULTINGJOB B ON A.JOB_ID = B.JOB_ID
FULL JOIN 
    EMADECONSULTINGDEPARTMENT C ON A.DEPARTMENT_ID = C.DEPARTMENT_ID
FULL JOIN 
    EMADECONSULTINGLOCATION D ON C.LOCATION_ID = D.LOCATION_ID
WHERE 
    A.SALARY > 
		(
        SELECT AVG(A1.SALARY)
        FROM EMADECONSULTINGEMPLOYEE A1
        --WHERE A1.DEPARTMENT_ID = A.DEPARTMENT_ID
		 )
select * 
from EMADECONSULTINGEMPLOYEE
where Salary > (
select avg(salary)
from EMADECONSULTINGEMPLOYEE as [avg]
where [avg].Department_ID = [AVG].Department_ID --(I DO NOT SEE THE RELEVANCE OF THIS SELF JOIN !!!)
)	

--PART 2

CREATE TABLE EMADECONSULTINGCUSTOMERS (
    CUSTOMER_ID INTEGER PRIMARY KEY,
    FIRST_NAME VARCHAR(100),
    LAST_NAME VARCHAR(100),
    EMAIL VARCHAR(100)
);

INSERT INTO EMADECONSULTINGCUSTOMERS (CUSTOMER_ID, FIRST_NAME, LAST_NAME, EMAIL) 
VALUES
(1, 'JOHN', 'DOE', 'JOHNDOE@EMAIL.COM'),
(2, 'JANE', 'SMITH', 'JANESMITH@EMAIL.COM'),
(3, 'BOB', 'JOHNSON', 'BOBJOHNSON@EMAIL.COM'),
(4, 'ALICE', 'BROWN', 'ALICEBROWN@EMAIL.COM'),
(5, 'CHARLIE', 'DAVIS', 'CHARLIEDAVIS@EMAIL.COM'),
(6, 'EVA', 'FISHER', 'EVAFISHER@EMAIL.COM'),
(7, 'GEORGE', 'HARRIS', 'GEORGEHARRIS@EMAIL.COM'),
(8, 'IVY', 'JONES', 'IVYJONES@EMAIL.COM'),
(9, 'KEVIN', 'MILLER', 'KEVINMILLER@EMAIL.COM'),
(10, 'LILY', 'NELSON', 'LILYNELSON@EMAIL.COM'),
(11, 'OLIVER', 'PATTERSON', 'OLIVERPATTERSON@EMAIL.COM'),
(12, 'QUINN', 'ROBERTS', 'QUINNROBERTS@EMAIL.COM'),
(13, 'SOPHIA', 'THOMAS', 'SOPHIATHOMAS@EMAIL.COM');


CREATE TABLE EMADECONSULTINGPRODUCTS (
    PRODUCT_ID INTEGER PRIMARY KEY,
    PRODUCT_NAME VARCHAR(100),
    PRICE DECIMAL
);


INSERT INTO EMADECONSULTINGPRODUCTS (PRODUCT_ID, PRODUCT_NAME, PRICE)
VALUES
(1, 'PRODUCT A', 10.00),
(2, 'PRODUCT B', 15.00),
(3, 'PRODUCT C', 20.00),
(4, 'PRODUCT D', 25.00),
(5, 'PRODUCT E', 30.00),
(6, 'PRODUCT F', 35.00),
(7, 'PRODUCT G', 40.00),
(8, 'PRODUCT H', 45.00),
(9, 'PRODUCT I', 50.00),
(10, 'PRODUCT J', 55.00),
(11, 'PRODUCT K', 60.00),
(12, 'PRODUCT L', 65.00),
(13, 'PRODUCT M', 70.00);


CREATE TABLE EMADECONSULTINGORDERS (
    ORDER_ID INTEGER PRIMARY KEY,
    CUSTOMER_ID INTEGER,
    ORDER_DATE DATE
);


INSERT INTO EMADECONSULTINGORDERS (ORDER_ID, CUSTOMER_ID, ORDER_DATE) 
VALUES
(1, 1, '2023-05-01'),
(2, 2, '2023-05-02'),
(3, 3, '2023-05-03'),
(4, 1, '2023-05-04'),
(5, 2, '2023-05-05'),
(6, 3, '2023-05-06'),
(7, 4, '2023-05-07'),
(8, 5, '2023-05-08'),
(9, 6, '2023-05-09'),
(10, 7, '2023-05-10'),
(11, 8, '2023-05-11'),
(12, 9, '2023-05-12'),
(13, 10, '2023-05-13'),
(14, 11, '2023-05-14'),
(15, 12, '2023-05-15'),
(16, 13, '2023-05-16');

CREATE TABLE ORDER_ITEMS (
    ORDER_ID INTEGER,
    PRODUCT_ID INTEGER,
    QUANTITY INTEGER
);

INSERT INTO ORDER_ITEMS (ORDER_ID, PRODUCT_ID, QUANTITY)
VALUES
(1, 1, 2),
(1, 2, 1),
(2, 2, 1),
(2, 3, 3),
(3, 1, 1),
(3, 3, 2),
(4, 2, 4),
(4, 3, 1),
(5, 1, 1),
(5, 3, 2),
(6, 2, 3),
(6, 1, 1),
(7, 4, 1),
(7, 5, 2),
(8, 6, 3),
(8, 7, 1),
(9, 8, 2),
(9, 9, 1),
(10, 10, 3),
(10, 11, 2),
(11, 12, 1),
(11, 13, 3),
(12, 4, 2),
(12, 5, 1),
(13, 6, 3),
(13, 7, 2),
(14, 8, 1),
(14, 9, 2),
(15, 10, 3),
(15, 11, 1),
(16, 12, 2),
(16, 13, 3);

--CHECK NEWLY CREATED TABLES
SELECT *
FROM EMADECONSULTINGCUSTOMERS

SELECT *
FROM EMADECONSULTINGORDERS

SELECT * 
FROM EMADECONSULTINGPRODUCTS

SELECT *
FROM ORDER_ITEMS

--JOIN TABLES
SELECT *
FROM EMADECONSULTINGCUSTOMERS A
JOIN EMADECONSULTINGORDERS B
	ON A.CUSTOMER_ID=B.CUSTOMER_ID
	JOIN ORDER_ITEMS C
	ON B.ORDER_ID=C.ORDER_ID
	JOIN EMADECONSULTINGPRODUCTS D
	ON C.PRODUCT_ID=D.PRODUCT_ID

--QUESTION 1 - WHICH PRODUCT HAS THE HIGHEST PRICE? ONLY RETURN A SINGLE ROW
SELECT * 
FROM EMADECONSULTINGPRODUCTS
WHERE PRICE= (
SELECT MAX(PRICE)
FROM EMADECONSULTINGPRODUCTS
)

--QUESTION 2 - WHICH CUSTOMER HAS MADE THE MOST ORDERS?
WITH ORDER_NO AS
	(
	SELECT 
		A.FIRST_NAME,
		A.LAST_NAME,
		A.EMAIL,
		COUNT(FIRST_NAME) 'NO. OF ORDERS'
	FROM EMADECONSULTINGCUSTOMERS A
	JOIN EMADECONSULTINGORDERS B
	ON A.CUSTOMER_ID=B.CUSTOMER_ID
	JOIN ORDER_ITEMS C 
	ON B.ORDER_ID=C.ORDER_ID
	GROUP BY 
		A.FIRST_NAME,
		A.LAST_NAME,
		A.EMAIL
	) 
SELECT *
FROM ORDER_NO
WHERE [NO. OF ORDERS] =
	(
	SELECT 
		MAX([NO. OF ORDERS]) MAX_ORDERS
	FROM ORDER_NO);

--QUESTION 2 - WHICH CUSTOMER HAS MADE THE MOST ORDERS? REDO
SELECT *
FROM EMADECONSULTINGCUSTOMERS A
	JOIN EMADECONSULTINGORDERS B
	ON A.CUSTOMER_ID=B.CUSTOMER_ID
	
WHERE ORDER_ID =
	(
	SELECT
		MAX(ORDER_ID) AS MAX_ORDERS
	FROM ORDER_ITEMS [MAX]
	WHERE [MAX].ORDER_ID=[MAX].ORDER_ID
	) 

--QUESTION 3- WHAT IS THE TOTAL REVENUE PER PRODUCT
SELECT 
    D.PRODUCT_NAME,
    SUM(C.QUANTITY * D.PRICE) AS TOTAL_REVENUE
FROM EMADECONSULTINGCUSTOMERS A
	JOIN EMADECONSULTINGORDERS B 
	ON A.CUSTOMER_ID = B.CUSTOMER_ID
	JOIN ORDER_ITEMS C 
	ON B.ORDER_ID = C.ORDER_ID
	JOIN EMADECONSULTINGPRODUCTS D 
	ON C.PRODUCT_ID = D.PRODUCT_ID
GROUP BY 
    D.PRODUCT_NAME;

--QUESTION 3- WHAT IS THE TOTAL REVENUE PER PRODUCT. REDO
SELECT B.PRODUCT_ID,
SUM(A.PRICE*B.QUANTITY) TOTAL_REVENUE
FROM EMADECONSULTINGPRODUCTS A
	JOIN ORDER_ITEMS B
	ON A.PRODUCT_ID=B.PRODUCT_ID
GROUP BY B.PRODUCT_ID;
	

--QUESTION 5 - FIND THE FIRST ORDER (BY DATE) FOR EACH CUSTOMER
WITH RANKEDORDERS AS 
	(
    SELECT 
        A.CUSTOMER_ID,
        A.FIRST_NAME,
        A.LAST_NAME,
        B.ORDER_ID,
        B.ORDER_DATE,
        ROW_NUMBER() OVER (PARTITION BY A.CUSTOMER_ID ORDER BY B.ORDER_DATE) AS RN
    FROM 
        EMADECONSULTINGCUSTOMERS A
    JOIN 
        EMADECONSULTINGORDERS B 
		ON A.CUSTOMER_ID = B.CUSTOMER_ID
	)
SELECT 
    CUSTOMER_ID,
    FIRST_NAME,
    LAST_NAME,
    ORDER_ID,
    ORDER_DATE
FROM 
    RANKEDORDERS
WHERE 
    RN = 1;
--QUESTION 5 - FIND THE FIRST ORDER (BY DATE) FOR EACH CUSTOMER. REDO
	
SELECT 
	FIRST_NAME,
	LAST_NAME,
	ORDER_DATE
FROM 
	(
		SELECT 
			A.FIRST_NAME,
			A.LAST_NAME,
			B.ORDER_DATE,
			ROW_NUMBER() OVER (PARTITION BY A.CUSTOMER_ID ORDER BY B.ORDER_DATE) RN
		FROM EMADECONSULTINGCUSTOMERS A
			JOIN EMADECONSULTINGORDERS B
			ON  A.CUSTOMER_ID=B.CUSTOMER_ID
	) X
WHERE RN=1
--QUESTION 6 -FIND THE TOP 3 CUSTOMERS WHO HAVE ORDERED THE MOST DISTINCT PRODUCTS
WITH CUSTOMERPRODUCTCOUNT AS 
	(
    SELECT 
        A.CUSTOMER_ID,
        A.FIRST_NAME,
        A.LAST_NAME,
        COUNT(DISTINCT C.PRODUCT_ID) AS DISTINCT_PRODUCT_COUNT
    FROM EMADECONSULTINGCUSTOMERS A
		JOIN EMADECONSULTINGORDERS B	
		ON A.CUSTOMER_ID = B.CUSTOMER_ID
		JOIN ORDER_ITEMS C 
		ON B.ORDER_ID = C.ORDER_ID
		JOIN EMADECONSULTINGPRODUCTS D 
		ON C.PRODUCT_ID = D.PRODUCT_ID
    GROUP BY 
        A.CUSTOMER_ID, 
		A.FIRST_NAME, 
		A.LAST_NAME
	)
SELECT TOP 3
    CUSTOMER_ID,
    FIRST_NAME,
    LAST_NAME,
    DISTINCT_PRODUCT_COUNT
FROM 
    CUSTOMERPRODUCTCOUNT
ORDER BY 
    DISTINCT_PRODUCT_COUNT DESC
;
--QUESTION 6 -FIND THE TOP 3 CUSTOMERS WHO HAVE ORDERED THE MOST DISTINCT PRODUCTS. REDO
SELECT TOP 3 *
FROM
	(
	SELECT A.FIRST_NAME,
		COUNT(DISTINCT D.PRODUCT_NAME) AS PRODUCTCOUNT
	FROM EMADECONSULTINGCUSTOMERS A
		JOIN EMADECONSULTINGORDERS B
		ON A.CUSTOMER_ID=B.CUSTOMER_ID
		JOIN ORDER_ITEMS C
		ON B.ORDER_ID=C.ORDER_ID
		JOIN EMADECONSULTINGPRODUCTS D
		ON C.PRODUCT_ID=D.PRODUCT_ID
	GROUP BY A.FIRST_NAME
	) X
	

--QUESTION 7 - WHICH PRODUCT HAS BEEN BOUGHT THE LEAST IN TERMS OF QUANTITY. 
SELECT TOP 1 
	D.PRODUCT_NAME,
	SUM(C.QUANTITY) TOTAL_QTY
FROM ORDER_ITEMS C
	JOIN EMADECONSULTINGPRODUCTS D
	ON C.PRODUCT_ID=D.PRODUCT_ID
GROUP BY D.PRODUCT_NAME
ORDER BY TOTAL_QTY ASC;


--QUESTION 8 - WHAT IS THE MEDIAN ORDER TOTAL (THE POWER OF CHATGPT IN FULLFORCE)
WITH ORDERTOTALS AS 
	(
    SELECT 
        B.ORDER_ID,
        SUM(C.QUANTITY * D.PRICE) AS TOTAL_AMOUNT,
        ROW_NUMBER() OVER (ORDER BY SUM(C.QUANTITY * D.PRICE)) AS RN,
        COUNT(*) OVER () AS TOTAL_ORDERS
    FROM EMADECONSULTINGORDERS B
		JOIN ORDER_ITEMS C 
		ON B.ORDER_ID = C.ORDER_ID
		JOIN EMADECONSULTINGPRODUCTS D 
		ON C.PRODUCT_ID = D.PRODUCT_ID
    GROUP BY B.ORDER_ID
	)
SELECT 
    AVG(TOTAL_AMOUNT) AS MEDIAN_ORDER_TOTAL
FROM ORDERTOTALS
WHERE RN IN ( (TOTAL_ORDERS + 1) / 2, (TOTAL_ORDERS + 2) / 2 );


--QUESTION 9 -FOR EACH ORDER, DETERMINE IF IT WAS 'EXPENSIVE' (TOTAL OVER 300)
--AFFORDABLE (TOTAL OVER 100), CHEAP (<100)
SELECT C.ORDER_ID,
	   SUM(C.QUANTITY*D.PRICE) AS TOTAL_PRICE,
CASE 
	WHEN SUM(C.QUANTITY*D.PRICE) > 300 THEN 'EXPENSIVE'
	WHEN SUM(C.QUANTITY*D.PRICE) > 100 THEN 'AFFORDABLE'
	ELSE 'CHEAP'
	END AS PRICE_RATING
FROM 
    EMADECONSULTINGORDERS B
	JOIN ORDER_ITEMS C 
	ON B.ORDER_ID = C.ORDER_ID
	JOIN EMADECONSULTINGPRODUCTS D 
	ON C.PRODUCT_ID = D.PRODUCT_ID
GROUP BY C.ORDER_ID;



--QUESTION 10 - FIND CUSTOMERS WHO HAVE ORDERED THE PRODUCT WITH THE HIGHEST PRICE(IF NOT FOR CHATGPT)
WITH HighestPricedProduct AS 
	(
    SELECT 
        PRODUCT_ID,
        PRICE
    FROM EMADECONSULTINGPRODUCTS
    WHERE PRICE = 
		(
		SELECT 
		MAX(PRICE) 
		FROM EMADECONSULTINGPRODUCTS)
		)
SELECT 
    A.CUSTOMER_ID,
    A.FIRST_NAME,
    A.LAST_NAME,
    D.PRODUCT_NAME,
    D.PRICE
FROM EMADECONSULTINGCUSTOMERS A
	JOIN EMADECONSULTINGORDERS B 
	ON A.CUSTOMER_ID = B.CUSTOMER_ID
	JOIN ORDER_ITEMS C 
	ON B.ORDER_ID = C.ORDER_ID
	JOIN EMADECONSULTINGPRODUCTS D 
	ON C.PRODUCT_ID = D.PRODUCT_ID
	JOIN HighestPricedProduct HPP 
	ON D.PRODUCT_ID = HPP.PRODUCT_ID;

--QUESTION 10 - FIND CUSTOMERS WHO HAVE ORDERED THE PRODUCT WITH THE HIGHEST PRICE. REDO
SELECT 
	C.ORDER_ID,
	A.FIRST_NAME

	from(

	SELECT 
	   sum(C.QUANTITY*D.PRICE) AS HIGHEST_PRICE
FROM 
    EMADECONSULTINGORDERS B
	JOIN ORDER_ITEMS C 
	ON B.ORDER_ID = C.ORDER_ID
	JOIN EMADECONSULTINGPRODUCTS D 
	ON C.PRODUCT_ID = D.PRODUCT_ID
	JOIN EMADECONSULTINGCUSTOMERS A
	ON A.CUSTOMER_ID=B.CUSTOMER_ID
	)


	--USING CTE 

	;WITH TABLE_A AS
	(
	SELECT 
	A.FIRST_NAME,
	A.MIDDLE_NAME,
	A.LAST_NAME,
	A.HIRE_DATE,
	A.SALARY,
	A.JOB_ID
FROM EMADECONSULTINGEMPLOYEE A
	),
	TABLE_B AS
		(
	SELECT 
		B.JOB_ID,
		B.DESIGNATION
	FROM  EMADECONSULTINGJOB B
		),
		TABLE_C AS
			(
		SELECT *
	FROM EMADECONSULTINGDEPARTMENT C 
			),
			TABLE_D AS
				(
			SELECT *
			FROM EMADECONSULTINGLOCATION D
				),
				 FINAL AS
					(
				SELECT A.*,B.DESIGNATION
				FROM TABLE_A A
				INNER JOIN TABLE_B B ON A.JOB_ID=B.JOB_ID
					)
/**	UPDATE FINAL
	SET DESIGNATION='SENIOR MANAGER'
	WHERE DESIGNATION='MANAGER';
	**/
SELECT *
FROM FINAL
	